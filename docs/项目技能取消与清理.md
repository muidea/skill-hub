# skill-hub 专项设计文档：项目技能取消与清理 (v1.0)

## 1. 设计目标
支持用户从当前项目中移除已启用的技能。取消操作不仅要更新状态记录，还必须物理清理目标配置文件（如 `.cursorrules` 或 `config.json`）中的注入内容，确保无残留、无污染。

## 2. 核心逻辑规范 (Principles)
*   **状态同步性**：从 `state.json` 的项目记录中移除技能 ID。
*   **物理清理性**：调用对应 Agent 的适配器，精准擦除标记块（Markers）及其包裹的内容。
*   **安全保护**：如果用户在该技能块内有未反馈（Feedback）的本地修改，取消前必须进行警告或提示。
*   **上下文一致性**：复用“智能路径解析算法”，自动识别当前目录所属项目的 Target 类型。

---

## 3. 详细设计实现

### 3.1 CLI 指令设计
*   **指令名称**：`skill-hub remove <id>`
*   **行为逻辑**：
    1.  **定位项目**：调用 `Context Resolver` 识别当前 CWD 所属项目及 `preferred_target`。
    2.  **验证存在性**：检查 `state.json` 中该项目是否启用了指定的 `[skill-id]`。
    3.  **状态检查 (Safety)**：
        *   计算该技能标记块的当前哈希。
        *   若与仓库原始哈希不一致，提示：“检测到本地修改，取消将丢失这些改动，是否继续？(y/n)”。
    4.  **执行物理清理**：
        *   读取目标配置文件。
        *   利用正则表达式匹配并删除该 ID 对应的 `BEGIN` 到 `END` 整个块。
    5.  **更新状态**：从 `state.json` 的 `enabled_skills` 数组中剔除该 ID。

### 3.2 适配器清理策略 (Adapter Cleanup)

#### A. 文本类适配器 (Cursor/.cursorrules)
*   **逻辑**：使用正则表达式匹配并删除。
*   **正则**：`(?s)\n?# === SKILL-HUB BEGIN: [ID] ===.*?# === SKILL-HUB END: [ID] ===\n?`
*   **要求**：清理后需处理多余的换行符，保持文件整洁。

#### B. JSON 类适配器 (Claude/config.json)
*   **逻辑**：
    *   **指令型**：解析 JSON 字符串，移除特定标记块片段，重新序列化。
    *   **工具型 (MCP)**：从 `mcpServers` 节点中删除以该技能 ID 为键的整个 JSON 对象。

---

## 4. 数据结构变更
本功能无需修改 `state.json` 的 Schema，仅涉及对 `enabled_skills` 切片（Slice）的常规操作。

```go
// internal/state/project.go
func (p *ProjectConfig) RemoveSkill(id string) {
    // 逻辑：遍历 enabled_skills，删除匹配项
}
```

---

## 5. 验收准则 (Acceptance Criteria)

### 模块 16：技能取消与清理验收

| 编号 | 验收项 | 验收指标 (Expectation) | 验证操作 |
| :--- | :--- | :--- | :--- |
| 16.1 | **状态移除确认** | 执行 `remove [id]` 后，`state.json` 中该项目的 `enabled_skills` 列表中不再包含该 ID。 | 运行指令，检查 `state.json`。 |
| 16.2 | **物理文件清理** | 目标文件（如 `.cursorrules`）中对应的标记块及其内容被完整删除，且不影响其他技能块。 | `apply` 两个技能，`remove` 其中一个，检查文件。 |
| 16.3 | **未同步警告** | 当标记块内有手动改动且未执行 `feedback` 时，执行 `remove` 必须弹出二次确认提示。 | 修改标记块内容后尝试 `remove`。 |
| 16.4 | **原子性备份** | 清理物理文件前，必须按照规范生成 `.bak` 备份文件。 | 执行 `remove`，检查同目录下是否有备份。 |
| 16.5 | **MCP 服务器注销** | 对于 Claude 工具型技能，执行 `remove` 后，`mcpServers` 配置中对应的节点必须被彻底删除。 | 在 Claude 环境下执行 `remove` 技能。 |
| 16.6 | **空文件处理** | 若取消的是项目中最后一个技能，清理后文件不应留有残留的空标记。 | 移除最后一个技能，检查文件是否恢复到初始状态（或仅留用户手写部分）。 |

---

## 6. 开发处理清单 (Backlog)

*   [ ] **Adapter 接口扩展**：在 `internal/adapter/adapter.go` 接口中增加 `Remove(skillID string, projectRoot string) error` 方法。
*   [ ] **实现 Cursor 清理逻辑**：编写基于正则的文本块删除函数。
*   [ ] **实现 Claude 清理逻辑**：编写 JSON 节点删除与指令字符串清洗逻辑。
*   [ ] **增加 remove 命令**：在 `internal/cli` 中实现 `remove.go`，集成逻辑链路。
*   [ ] **集成安全检查**：在执行删除动作前调用 `engine` 的 Diff 计算功能。

---
