# 基于状态绑定的多目标识别系统

---

## 1. 设计背景 (Background)
在多智能体（Agent）并存的开发环境下（如同时使用 Cursor 和 Claude Code），skill-hub 需要精准识别当前操作应作用于哪个目标工具。为了避免频繁手动指定参数，本方案通过 `state.json` 建立“**路径-目标**”的强绑定关系，实现操作的自动化路由。

---

## 2. 设计目标 (Objectives)
*   **持久化绑定**：一次设置，永久记录项目与 AI 工具（Target）的关联。
*   **智能识别**：支持从项目子目录向上递归查找关联记录，实现“处处运行，精准识别”。
*   **灵活切换**：支持通过 CLI 指令随时修改首选目标，或通过参数临时覆盖。

---

## 3. 数据模型 (Data Model)

### 3.1 状态中心 (`~/.skill-hub/state.json`)
这是识别系统的核心数据库。它以项目的**绝对路径**为键，记录该项目的配置信息。

```json
{
  "projects": {
    "/Users/dev/work/project-alpha": {
      "preferred_target": "claude_code",
      "enabled_skills": ["git-expert", "py-refactor"],
      "vars": {
        "LANGUAGE": "zh-CN"
      },
      "last_sync": "2023-10-27T10:00:00Z"
    },
    "/Users/dev/work/project-beta": {
      "preferred_target": "cursor",
      "enabled_skills": ["react-helper"],
      "vars": {},
      "last_sync": "2023-10-27T12:00:00Z"
    }
  }
}
```

### 3.2 目标类型枚举 (Target Types)
在代码中定义标准的目标类型常量：
*   `cursor`: 对应 `.cursorrules` 适配器。
*   `claude_code`: 对应 `.clauderc` 或 `config.json` 适配器。
*   `unknown`: 初始或未识别状态。

---

## 4. 核心机制实现 (Core Mechanism)

### 4.1 智能路径解析算法 (Path Resolution)
当用户在终端执行指令时，系统通过以下流程确定上下文：
1.  **获取 CWD**：获取当前工作目录的绝对路径。
2.  **递归回溯 (Walk-up)**：
    *   检查 CWD 是否存在于 `state.json` 的 `projects` 键中。
    *   若无，则移动至父目录继续检查，直至到达根目录或匹配成功。
3.  **确定 ProjectRoot**：匹配成功后，该路径即为项目的根目录，其对应的 `preferred_target` 即为后续操作的默认目标。

### 4.2 目标识别优先级 (Resolution Priority)
解析引擎按以下优先级确定最终执行的 Target：
1.  **命令行显式参数**：用户执行时带入的 `--target [val]`。
2.  **State 记录**：`state.json` 中该路径绑定的 `preferred_target`。
3.  **交互式提示**：若前两项均无，工具将弹出选择列表（Cursor/Claude）并引导用户完成首次绑定。

---

## 5. CLI 指令设计 (Command Interface)

### 5.1 绑定与修改指令
*   **`skill-hub use <id> [--target <value>]`**
    *   首次在项目中使用技能时，强制要求或交互式引导设置 `preferred_target` 并存入 `state.json`。
*   **`skill-hub set-target <value>`**
    *   显式修改当前项目绑定的首选目标。支持快捷切换，如从 `cursor` 切换到 `claude_code`。

### 5.2 自动感知指令
*   **`skill-hub apply [--dry-run] [--force]`**
*   **`skill-hub status [id] [--verbose]`**
*   **`skill-hub feedback <id> [--dry-run] [--force]`**
    *   **行为**：不再要求必须带 `--target`。
    *   **逻辑**：自动通过“路径解析算法”识别目标。
    *   **输出示例**：`Context Detected: Claude Code | Project: /Users/dev/work/app`

---

## 6. 开发调整清单 (Implementation Backlog)

### 6.1 internal/state 模块
*   [ ] 扩展 `ProjectConfig` 结构体，新增 `PreferredTarget` 字段。
*   [ ] 实现 `FindConfigByPath(path string)` 函数，封装递归回溯逻辑。

### 6.2 internal/engine 模块
*   [ ] 重构适配器调用逻辑：支持根据 `TargetType` 动态分发任务至对应的适配器 (Adapter)。
*   [ ] 增加“目标-技能”兼容性检查：若 `SKILL.md` 定义仅支持 Cursor，但项目绑定为 Claude，则执行 `apply` 时发出警告。

### 6.3 cmd 模块
*   [ ] 修改 `apply` 等指令：将 `target` 参数改为可选，并接入路径解析逻辑。
*   [ ] 实现 `set-target` 子命令逻辑。

---

## 7. 验收准则 (Acceptance Criteria)

### 7.1 绑定准确性
*   **AC 1**: 执行 `use` 指令并选择目标后，`state.json` 必须正确持久化该路径的 `preferred_target`。
*   **AC 2**: 跨项目操作时，两个不同目标的项目的 `state.json` 记录互不干扰。

### 7.2 智能解析能力
*   **AC 3**: 在项目深层子目录下运行 `apply`，工具必须能准确识别出父级项目绑定的目标（如识别为 Claude 并更新根目录的 `.clauderc`）。
*   **AC 4**: 通过 `set-target` 命令设置的目标必须能 100% 覆盖 `state.json` 的记录，且不修改原有的持久化绑定。

### 7.3 异常处理
*   **AC 5**: 在从未绑定过目标的全新目录运行 `apply`，工具应友好提示并要求先执行 `set-target` 或进行交互式绑定。

---

## 8. 总结
本子系统通过“**以路径为索引的状态映射**”，解决了多 Agent 环境下的上下文识别难题。它将原本需要用户记忆的配置负担转嫁给了 `state.json` 的自动化查询，确立了 skill-hub 作为一个专业、智能的管理工具的基础。
